# Learning Note: Head-to-Head (H2H) Metrics & Matchup Edge

## What is it?
Head-to-Head (H2H) metrics look specifically at the historical results between two specific teams (e.g., Lakers vs. Celtics) rather than their general performance against the rest of the league.

## Why does it matter?
1. **Psychological Edge**: Some teams simply "own" others. Whether it's stylistic matchup problems (e.g., a fast team vs. a slow physical team) or mental barriers, historical dominance often persists.
2. **Stylistic Clash**: A team might be 1st in the league defensively but struggle specifically against teams that shoot high volumes of 3-pointers. H2H data captures these nuanced stylistic interactions that general rolling averages miss.
3. **Venue Influence**: H2H stats often highlight if a team struggles specifically in a certain city (e.g., the "altitude effect" in Denver or the "nightlife effect" in Miami/LA).

## How it works (The Intuition)
Imagine two boxers.
- **Boxer A**: 20-0 record (General performance).
- **Boxer B**: 15-5 record (General performance).
- **Matchup**: Boxer B has beaten Boxer A in all 3 of their previous fights.
Even though Boxer A is "better" on paper against the field, Boxer B has a clear **Matchup Edge**. H2H features encode this specific relationship.

### SQL Implementation: The Self-Join
To calculate this, we join the `matches` table to itself to find all previous games where Team A was the home team and Team B was the visitor (and vice versa).

```sql
SELECT 
    m1.game_id,
    AVG(CASE WHEN m2.winner_team_id = m1.home_team_id THEN 1 ELSE 0 END) as h2h_home_win_pct
FROM matches m1
JOIN matches m2 
    ON m1.home_team_id = m2.home_team_id 
    AND m1.away_team_id = m2.away_team_id
    AND m2.game_date < m1.game_date -- Again, avoid data leakage!
GROUP BY m1.game_id
```

## When to use vs. Alternatives
- **H2H (Current Choice)**: High precision for specific matchups, but lower sample size (teams only play 2-4 times a season).
- **Strength of Schedule (SOS) Adjusted Stats**: Adjusts general performance based on how hard their opponents were.
- **Elo Ratings**: A single number representing team strength that updates after every game (very common in FiveThirtyEight's models).

## Common Interview Questions
1. **"Isn't H2H data too sparse to be useful (low sample size)?"**
   - *Answer*: Yes, that's a risk. We treat H2H as a *secondary* signal. Our model uses rolling averages for the "main" signal and uses H2H to refine the prediction in cases of strong historical trends. We also use a Bayesian prior or a minimum game threshold to avoid overreacting to a single 1-0 H2H record.
2. **"How do you handle teams with significant roster changes in H2H stats?"**
   - *Answer*: This is where H2H can fail. If the Lakers play the Celtics, but both teams have traded their entire starting lineups since the last matchup, the old H2H data is less relevant. We handle this by adding a "Season Decay" factor, where games from 3 years ago weigh significantly less than games from last year.

## Senior Manager / Architect Perspective
> "Generic features tell you how good a team is. Matchup features tell you how they'll perform against *this specific opponent*. In a high-parity league like the NBA, the 'Matchup Edge' is often the difference between a 55% model and a 60% model. By engineering these H2H features, we're giving the model the ability to identify stylistic 'kryptonite' scenarios."

---
*Generated by the Sports Analytics Intelligence Platform*
